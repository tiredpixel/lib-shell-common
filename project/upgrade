#!/usr/bin/env bash
set -Eeuo pipefail

self=$(realpath "${BASH_SOURCE[0]}")
dir=$(dirname "$self")

"$dir/../git/recursive" pull --no-recurse-submodules

"$dir/each" sh -c "
    make -q upgrade ; test $? -eq 2 || test \"$(realpath upgrade)\" = \"$self\" || make upgrade"

make build

"$dir/each" sh -c '
    make -q test ; test $? -eq 2 || make test'

"$dir/each" sh -c '
    make -q upgrade-freeze ; test $? -eq 2 || make upgrade-freeze'

"$dir/each" sh -c '
    test ! -f docker-compose.yml || docker compose stop'

make build

"$dir/each" sh -c '
    test ! -f docker-compose.yml || docker compose stop'
